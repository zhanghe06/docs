# 幂等设计 (Idempotent)

关于幂等的思考

所有的接口，包括第三方，无非就这几种返回形式：
- 正常响应，结果正确
- 正常响应，结果错误
- 异常响应
- 响应超时

任务系统中，如果遇到错误、异常、超时这3中情况，是要做任务回退处理的，一般是清理未完成的资源、还原任务初始数据等。

1. 对于第一种错误：
仅仅需要处理自身的回退，通常这种错误，是由于不满足外部条件导致操作不成功，对数据没有副作用

2. 对于第二种异常：
不仅需要处理自身的回退，还要发起外部的回退

3. 对于第三种超时：
结束自身任务，需要处理自身的回退，还要发起外部的回退

扩展：如何设计外部回退请求的处理

用户 | 银行 | 余额
--- | --- | ---
A | 建行 | 2000
B | 农行 | 2000
C | 建行 | 2000

- A跨行给B转账1000
- A同行给C转账1000

A为建行的用户，所以这里以建行的角度思考系统设计

针对以上交易场景，比较以下2种设计：

一、通常设计

步骤 | 动作
--- | ---
1 | 执行扣除A余额动作
2 | 发起新增B余额请求

如果第2步超时，这时没法判断整个流程是否正常

二、幂等设计

步骤 | 操作 | 动作 | 备注
--- | --- | --- | ---
1 | 保持A余额不变 | - | -
2 | 新增A扣款记录 | 并标记进行中 | -
3 | 发起B收款请求 | 等待返回结果 | -
4 | 收到B收款结果 | 成功 - A扣款记录已完成 | -
5 | 收到B收款结果 | 失败 - A扣款记录已失败 | -
6 | 更新A账户余额 | - | 第4步引发更新

转账接口需要带上时间戳并签名，防止请求重放
