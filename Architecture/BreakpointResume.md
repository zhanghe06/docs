# 断点续传 (Breakpoint Resume)

## 断点

断点的基础是将文件分段/分片

## 续传

续传的前提是需要能识别出再次上传的文件是否与上一次相同，另外，续传开始时需要知道从哪开始续

## 秒传

在已实现断点上传功能之上，秒传的实现逻辑就非常清晰了。客户端在调用file/upload接口上传文件之前先调用/file/progress/{hash}接口判断相同hash值文件的上传情况，再决定下一步处理。

客户端计算文件hash，并以文件hash和文件大小作为参数调用/file/progress/{hash}接口
服务端根据上传hash值判断文件是否已上传，若存在返回已上传文档大小（bytes）
客户端收到服务端响应后根据文件是否存在及已存在文件大小判断**秒传**、**断点续传**还是**新上传**
秒传，返回文件长度与当前准备上传文件长度大小一致
断点续传，返回文件大小比当前准备上传文件长度小
新上传，返回文件不存在
其它情况，作为新文件上传


前端计算文件的hash（使用sha256），将hash传到后端查询是否有相同文件已上传，若有将返回已上传文件及文件长度（bytes）。 
这时候前端就可以知道文件的上传进度，进而判断还需要断点续传的偏移量或者已上传完成（这就是秒传）。


这里有一个设计取舍：客户端对单个文件不做分片，从文件头开始上传。
这样的一个好处是可简化服务端的实现，同时也可以优化服务端对文件的存储：
同一个文件将一直使用APPEND的方式写入文件，这样可以更高效的利用磁盘IO。
同时，不需要分块合并，若文件很大，生成的大量分块在文件上传完成后再次合并会是一个非常大的资源开销。

## 上传

服务端：支持分片上传

## 下载

服务端：支持分片（基于字节范围）下载
