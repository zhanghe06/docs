# 消息队列 (Message Queue)

## 应用场景

- 解耦
- 削峰限流
- 最终一致性
- 广播

## 组件对比

参考: https://zhuanlan.zhihu.com/p/60288391

特性 | ActiveMQ | RabbitMQ | RocketMQ | Kafka
--- | --- | --- | --- | ---
开发语言 | java | erlang | java | scala
单机吞吐量 | 万级 | 万级 | 10万级 | 10万级
时效性 | ms级 | us级 | ms级 | ms级以内
可用性 | 高(主从架构) | 高(主从架构) | 非常高(分布式架构) | 非常高(分布式架构)
功能特性 | 协议支持较好 | 管理界面丰富 | MQ功能完备 | 只支持主要MQ功能
缺点 | 社区维护少 | 吞吐量低 | 客户端语言支持不多 | 消费失败不支持重试

## 异步阻塞模型

新建资源 - 生产任务（数据库与任务队列的顺序策略）

序号 | 数据处理 | 消息处理
:---: | --- | ---
1 | 创建记录，设置状态：准备中 | -
2 | - | 发送消息
3 | 更新状态：创建中 | 发送成功
4 | 更新状态：已失败 | 发送失败


新建资源 - 消费任务（数据库与任务队列的顺序策略）

序号 | 数据处理 | 消息处理
:---: | --- | ---
1 | - | 订阅任务
2 | - | 获取任务
3 | - | 消费任务（阻塞）
4 | 更新状态：已完成 | 消费完成
5 | - | 确认（成功/失败）

- 消费过程中，异常断电，消息如何处理的？  
    + 3-4步断电：重启任务，非幂等操作可能有副作用
    + 4-5步断电：消费前检查数据任务状态，已完成，则忽略
- 重新启动之后，消息是否自动重新入队？  
    + 设置持久化之后，重回队列


新建资源 - 任务结果（数据库与结果队列的顺序策略）

序号 | 数据处理 | 消息处理
:---: | --- | ---
1 | - | 订阅结果
2 | - | 消费结果（阻塞）
3 | 更新状态：已完成 | 消费完成
4 | 更新状态：已超时 | 消费超时


## 消息幂等

## 并发场景支持消息幂等
